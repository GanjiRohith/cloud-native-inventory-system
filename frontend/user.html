<!DOCTYPE html>
<html>
<head>
    <title>User Dashboard</title>

    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet">
</head>

<body class="container mt-5">

<h2>User Dashboard</h2>

<hr>

<h4>Available Products</h4>

<select id="product" class="form-control mb-3"></select>

<input
id="qty"
type="number"
class="form-control mb-3"
placeholder="Enter Quantity"
/>

<button
onclick="placeOrder()"
class="btn btn-success">
Place Order
</button>

<hr>

<h4>Your Orders</h4>

<table class="table table-bordered">

<thead class="table-dark">
<tr>
<th>Order ID</th>
<th>User</th>
<th>Product</th>
<th>Quantity</th>
</tr>
</thead>

<tbody id="orders"></tbody>

</table>

<button
class="btn btn-danger"
onclick="logout()">
Logout
</button>


<script>

const db = localStorage.getItem("db");


/* ================= LOAD PRODUCTS ================= */

async function loadProducts(){

let res = await fetch(`/products?db=${db}`);
let products = await res.json();

let select = document.getElementById("product");
select.innerHTML="";

products.forEach(p=>{

select.innerHTML += `
<option value="${p.id}">
${p.name} | ₹${p.price} | Stock: ${p.quantity}
</option>
`;

});

}


/* ================= PLACE ORDER ================= */

async function placeOrder(){

let productId =
document.getElementById("product").value;

let qty =
document.getElementById("qty").value;

if(qty <= 0){
alert("Enter valid quantity");
return;
}

let response = await fetch("/orders",{
method:"POST",
headers:{
"Content-Type":"application/json"
},
body:JSON.stringify({
user_id:localStorage.getItem("user_id"),
products:[
{
product_id:productId,   // ✅ STRING SAFE FOR BOTH DBs
quantity:Number(qty)
}
],
db:db
})
});

let result = await response.json();

alert(JSON.stringify(result));

loadProducts();
loadOrders();
}


/* ================= LOAD ORDERS ================= */

async function loadOrders(){

let res = await fetch(`/orders?db=${db}`);
let orders = await res.json();

let html="";

orders.forEach(o=>{

html += `
<tr>
<td>${o.id}</td>
<td>${o.user_id}</td>
<td>${o.product_id}</td>
<td>${o.quantity}</td>
</tr>
`;

});

document.getElementById("orders").innerHTML = html;

}


/* ================= LOGOUT ================= */

function logout(){

localStorage.clear();
window.location.href="/";

}


/* ================= INITIAL LOAD ================= */

loadProducts();
loadOrders();

</script>

</body>
</html>